<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>治疗调查</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<script type="text/javascript" src="../../../../PUBLIC/Scripts/common.js"></script>
<script type="text/javascript" src="../../../../PUBLIC/Scripts/jsloader.js"></script>
<script type="text/javascript" src="../../../../PUBLIC/Scripts/jsloader_jquery.js"></script>
<link type="text/css" rel="stylesheet" href="../../../../PUBLIC/Scripts/MyJavascripts/tableform/table.css"/>
<script type="text/javascript" src="../../../../PUBLIC/Scripts/My97DatePicker/WdatePicker.js"></script>
<script type="text/javascript" src="../../../../PUBLIC/Scripts/MyJavascripts/tableform/FormUtil.js"></script>
<link type="text/css" rel="stylesheet" href="../../css/InHspRec.css"/>
<script type="text/javascript">
var itemName = App.util.getHtmlParameters('nodeText');
var spanContent = parent.document.getElementById('aidsHistory').contentWindow.dbclickedSpan;
$(function(){
	initPage();
	if(spanContent != null){
		spanContent = $(spanContent).html();
		jqueryObj = $('<div>' + spanContent + '</div>');
		jqueryObj.appendTo($('#composeInfo'));
		spanContent = jqueryObj.find("span").eq(0).html();
		FormUtil.setFormValues('form',JSON.parse(spanContent));
		var treatFunOldOpertion = jqueryObj.find("span").eq(1).html();
		if(treatFunOldOpertion && treatFunOldOpertion != 'undefined'){
			$('img[name="treatImg"]').data("results", JSON.parse(treatFunOldOpertion));
		}
		showOrHide(JSON.parse(spanContent));
	}
});
		
function showOrHide(json){
	if(json.treatProcessFlag == 0 || json.treatProcessFlag == 1 || json.treatProcessFlag == 2 || json.treatProcessFlag == 3 || json.treatProcessFlag == 9){
		$('#memoTable').show();
	}	
	if(json.treatProcessFlag == 4){
		$('#detailTable').show();
	}	
	if(json.treatProcessFlag == 5){
		$('#unit').show();
		$('#detailTable').show();
	}
	if(json.hospitalName == 1 || json.hospitalName ==2){
		$('input[name="hospitalName"]').parent().parent().next().show();
	}	
	if(json.treatFn == 1 || json.treatFn == 2 || json.treatFn == 3 || json.treatFn == 9){
		$('input[name="treatFn"]').parent().parent().next().show();
		$('#detailTable2').show();
	}
	
	var temp = json.treatFn;
	$('input[name="treatFlag"]').parent().find('span').each(function(){
		if($(this).html() == "为进一步诊治收治入院"){
			if(temp == 3){
				$(this).hide();
				$(this).prev().hide();
			}else{
				$(this).show();
				$(this).prev().show();
			}
		}
	});
	
	if(json.checkRstFlag == 0 || json.checkRstFlag == 1 || json.checkRstFlag == 2){
		$('input[name="checkRstFlag"]').parent().parent().next().show();
	}
	
	if(json.diagRstFlag == 0 || json.diagRstFlag == 1){
		$('input[name="diagRstFlag"]').parent().parent().next().show();
	}
	if(json.diagRstFlag == 3){
		$('input[name="diagRstFlag"]').parent().parent().next().next().show();
	}
	
	if(json.treatFlag == 0 || json.treatFlag == 1 || json.treatFlag == 2 || json.treatFlag == 3 || json.treatFlag == 4 || json.treatFlag == 6){
		$('input[name="treatFlag"]').parent().parent().next().show();
		if(json.treatFlag == 4){
			$("#treatImg").show();
		}
	}
}

function isRadioSelected(radios) {
	for (var i = 0; i < radios.length; i++) {
		if (radios[i].checked == true) {
			return $(radios[i]).val();
		}
	}
	return -111;
}

function initPage(){
	//初始化公共字典值
	$.each(FormUtil.getPageDictionaryNew('EMR-liver-PresentIllnessHistory-Treat'),function(code){
		$('input[name="'+code+'"]').data('options',this);
	});
	//Select初始化
	$('input.select').each(function(){
		FormUtil.toCombobox({el:$(this)});
	});
	//Radio初始化
	$('input.dict-fld').each(function(){
		FormUtil.initDictRadio($(this));
	});
	//Checkbox初始化
	$('input.checkbox').each(function(){
		FormUtil.toCheckbox({el:$(this)});
	});
	//选择就诊方式后显示的内容
	$('input[name="treatFn"]').click(function(){
		$('#detailTable2').show();
		$(this).parent().parent().next().show();
		var temp = $(this).val();
		$('input[name="treatFlag"]').parent().find('span').each(function(){
			if($(this).html() == "为进一步诊治收治入院"){
				if(temp == 3){
					$(this).hide();
					$(this).prev().hide();
				}else{
					$(this).show();
					$(this).prev().show();
				}
			}
		});
	
		if(isRadioSelected(document.getElementsByName('treatFn')) == 1){
			if(isRadioSelected(document.getElementsByName('treatProcessFlag')) == 4){
				$('input[name="treatFn0"]').val($('input[name="treatTime"]').val() + $('input[name="treatTimeUnit"]').val() + $('input[name="treatTimeUnitSuffix"]').val() + '于我院门诊就诊');
				$('input[]').val()
			}
			if(isRadioSelected(document.getElementsByName('treatProcessFlag')) == 5){
				if($('input[name="inspectionUnit"]').val() == ''){
					alert('请选择当地医院/外地医院,并填写具体名称');
					return;
				}
				$('input[name="treatFn0"]').val($('input[name="treatTime"]').val() + $('input[name="treatTimeUnit"]').val() + $('input[name="treatTimeUnitSuffix"]').val() + '于' + $('input[name="inspectionUnit"]').val() + '门诊就诊');
			}
		}
		if(isRadioSelected(document.getElementsByName('treatFn')) == 2){
			if(isRadioSelected(document.getElementsByName('treatProcessFlag')) == 4){
				$('input[name="treatFn0"]').val($('input[name="treatTime"]').val() + $('input[name="treatTimeUnit"]').val() + $('input[name="treatTimeUnitSuffix"]').val() + '于我院急诊就诊');
			}
			if(isRadioSelected(document.getElementsByName('treatProcessFlag')) == 5){
				if($('input[name="inspectionUnit"]').val() == ''){
					alert('请选择当地医院/外地医院,并填写具体名称');
					return;
				}
				$('input[name="treatFn0"]').val($('input[name="treatTime"]').val() + $('input[name="treatTimeUnit"]').val() + $('input[name="treatTimeUnitSuffix"]').val() + '于' + $('input[name="inspectionUnit"]').val() + '急诊就诊');
			}
		}
		if(isRadioSelected(document.getElementsByName('treatFn')) == 3){
			if(isRadioSelected(document.getElementsByName('treatProcessFlag')) == 4){
				$('input[name="treatFn0"]').val($('input[name="treatTime"]').val() + $('input[name="treatTimeUnit"]').val() + $('input[name="treatTimeUnitSuffix"]').val() + '于我院住院治疗');
			}
			if(isRadioSelected(document.getElementsByName('treatProcessFlag')) == 5){
				if($('input[name="inspectionUnit"]').val() == ''){
					alert('请选择当地医院/外地医院,并填写具体名称');
					return;
				}
				$('input[name="treatFn0"]').val($('input[name="treatTime"]').val() + $('input[name="treatTimeUnit"]').val() + $('input[name="treatTimeUnitSuffix"]').val() + '于' + $('input[name="inspectionUnit"]').val() + '住院治疗');
			}																	
		}
		if(isRadioSelected(document.getElementsByName('treatFn')) == 9){
			if(isRadioSelected(document.getElementsByName('treatProcessFlag')) == 4){
				$('input[name="treatFn0"]').val($('input[name="treatTime"]').val() + $('input[name="treatTimeUnit"]').val() + $('input[name="treatTimeUnitSuffix"]').val() + '于我院');
			}
			if(isRadioSelected(document.getElementsByName('treatProcessFlag')) == 5){
				if($('input[name="inspectionUnit"]').val() == ''){
					alert('请选择当地医院/外地医院,并填写具体名称');
					return;
				}
				$('input[name="treatFn0"]').val($('input[name="treatTime"]').val() + $('input[name="treatTimeUnit"]').val() + $('input[name="treatTimeUnitSuffix"]').val() + '于' + $('input[name="inspectionUnit"]').val());
			}	
		}
	});
	//选择就诊医院后显示的内容
	$('input[name="hospitalName"]').click(function(){
		$(this).parent().parent().next().show();
	});
	//选择检查情况后显示的内容
	$('input[name="checkRstFlag"]').click(function(){
		$(this).parent().parent().next().show();
	});
	//raido显示隐藏事件
	$('*[name="treatProcessFlag"]').click(function(){
		if(this.value==4||this.value==5){
			$('#memoTable').hide();
			$('#detailTable').show();
			if(this.value == 5){
				$('#unit').show();
			}else {
				$('#unit').hide();
			}
			if(isRadioSelected(document.getElementsByName('treatFn')) != -111){
				$('#detailTable2').show();
			}
		}else{
			$('#memoTable').show();
			$('#detailTable').hide();
			$('#detailTable2').hide();
			$('#unit').hide();
			if(this.value == 0){
				$('textarea[name="treatProcessDesc"]').val('未诊治 ');
			}
			if(this.value == 1){
				$('textarea[name="treatProcessDesc"]').val('未到医院诊治');
			}
			if(this.value == 2){
				$('textarea[name="treatProcessDesc"]').val('具体诊治情况不详');
			}
			if(this.value == 3){
				$('textarea[name="treatProcessDesc"]').val('未到医院诊治，自行服药治疗');
			}
			if(this.value == 9){
				$('textarea[name="treatProcessDesc"]').val('');
			}
		}
	});
	
	$('input[name="hospitalName"]').click(function(){
		if($(this).val() == 1){
			$('input[name="inspectionUnit"]').val('当地医院');
		}
		if($(this).val() == 2){
			$('input[name="inspectionUnit"]').val('外地医院');
		}
	});
	
	$('*[name="diagRstFlag"]').click(function(){
		if(this.value==0){
			$(this).parent().parent().next().next().hide();
			$(this).parent().parent().next().show();
			$('input[name="diagRst"]').val("未明确诊断");
		}else if(this.value==1){
			$(this).parent().parent().next().next().hide();
			$(this).parent().parent().next().show();
			$('input[name="diagRst"]').val("诊断为");
		}else if(this.value==3){
			$(this).parent().parent().next().next().show();
			$(this).parent().parent().next().hide();
		}else{
			$(this).parent().parent().next().next().hide();
			$(this).parent().parent().next().hide();
		}
	});
	
	$('tr[name="zhiliaomiaoshu"]').hide();
	$('tr[name="zhiliaojieguo"]').hide();
	$('*[name="treatFlag"]').click(function(){
		$('tr[name="zhiliaomiaoshu"]').show();
		$('tr[name="zhiliaojieguo"]').show();
		if(this.value==0||this.value==1){
			$("#treatImg").hide();
		}else{
			$(this).parent().parent().next().show();
			$(this).parent().parent().next().next().show();
		}
		if(this.value==0){
			$('textarea[name="treat"]').val("未行治疗");
		}
		if(this.value==2 || this.value==6){
			$("#treatImg").hide();
			$('textarea[name="treat"]').val("自行服用");
		}
		if(this.value==3){
			$('textarea[name="treat"]').val("为进一步诊治收治入院");
		}
		if(this.value==4){
			$('textarea[name="treat"]').val("");
			$("#treatImg").show();
		}
		if(this.value==1){
			$('textarea[name="treat"]').val("具体治疗不详");
		}
		if(this.value==6){
			$('textarea[name="treat"]').val("");
		}
	});
	
	$('*[name="treatImg"]').each(function() {		
		$(this).click(function() {
			var flag = $(this).attr("flag");
			var value = window.showModalDialog(
					'PastHistory_TreatFunction.html?time='
							+ new Date().getTime(), {
						flag : flag,
						data : $(this).data('results')
					}, "dialogHeight:" + screen.height * 0.5
							+ "px;dialogwidth:1000px;");
			if (value) {
				$(this).data("results", value.data);
				$(this).parent().find('textarea[name="treat"]').val(value.text);
			}
		});
	});
	
	//raido显示隐藏事件
	$('*[name="checkRstFlag"]').each(function(){
		$(this).click(function(){
			var val=0;
			$('*[name="'+$(this).attr('name')+'"]').each(function(){
				if(this.checked){
					val=$(this).val();
					return false;
				}
			});
			if(this.value==0){
				$('textarea[name="checkRst"]').val("未行检查");
			}
			if(this.value==2){
				$('textarea[name="checkRst"]').val("检查结果不详");
			}
			if(this.value==1){
				$('textarea[name="checkRst"]').val("检查结果：");
			}
		});
	});
	
	//确定事件
	$('#ok-btn').click(function(){
		var value=FormUtil.getFormValues('form');
		var oldOperation = JSON.stringify(value);
		var treatFunOldOperation = JSON.stringify( $('img[name="treatImg"]').data("results"));
		var grids=[];
		value.grids=grids;
		var rst=Compose(value);
		if(Compose(value) == -1) return;
		if(rst.length > 0){
			rst = '<span ondblclick="' + "{dbclickedSpan=$(this);$('span').addClass('blackstyle');$(this).removeClass('blackstyle');$(this).addClass('redstyle');parent.hideAidsHis();parent.symptomInfoIfr('treat.html', itemName);}" + '" onclick="' + "{var i; for(i = 0; i < store.getCount(); i++){if(store.getAt(i).get('serialNo') == $(this).attr('name')) break;} Ext.getCmp('symptomItemList').getSelectionModel().clearSelections();if($(this).css('color') == 'red'){$('span').addClass('blackstyle');}else{Ext.getCmp('symptomItemList').getSelectionModel().selectRow(i);$('span').addClass('blackstyle');$(this).removeClass('blackstyle');$(this).addClass('redstyle');}}" + '">' + rst + '<span style="display:none">' + oldOperation + '</span>' + '<span style="display:none">' + treatFunOldOperation + '</span>' + '</span>';
			var iframe = parent.document.getElementById('aidsHistory');
			iframe.contentWindow.itemValue = rst;
			if(iframe.contentWindow.dbclickedSpan){
				iframe.contentWindow.setReturnValue(iframe.contentWindow.dbclickedSpan);
			}else{
				iframe.contentWindow.setReturnValue();
			}
		}
		backToPreIllWindow();
	});
}

function backToPreIllWindow(){
	parent.document.getElementById('aidsHistory').contentWindow.dbclickedSpan = null;
	parent.hideSymptomInfoIfr();
	parent.showAidsHis();	
}

function Compose(value){
	var rst='';
	var leftInputItem = '';
	var rightInputItem = '';
	var temp=getRowValue('treatProcessFlag',value.treatProcessFlag);
	if(temp.length==0)return '';
	if(value.treatProcessFlag==0||value.treatProcessFlag==1||value.treatProcessFlag==2||value.treatProcessFlag==3){
		if(value.treatProcessDesc != ""){
			leftInputItem = '<input name="lrtreatProcessDesc" type="text" value="" />';
			rightInputItem = '<input name="lrtreatProcessDesc" type="text" value="。" />';
			if($('input[name="lrtreatProcessDesc"]').size() > 0){
				$('input[name="lrtreatProcessDesc"]').eq(0).wrap("<div id='wrap'></div>");
				leftInputItem = $('#wrap').html();
				$('#wrap').replaceWith($('#wrap').html());		
				$('input[name="lrtreatProcessDesc"]').eq(1).wrap("<div id='wrap'></div>");
				rightInputItem = $('#wrap').html();
				$('#wrap').replaceWith($('#wrap').html());
			}
			rst=leftInputItem+value.treatProcessDesc+rightInputItem;
		}
	}else if(value.treatProcessFlag==9){
		if(value.treatProcessDesc != ""){
			rst=value.treatProcessDesc+'。';
		}
	}else if(value.treatProcessFlag==4||value.treatProcessFlag==5){
		if(value.treatFn0 != ""){
			rst+=value.treatFn0 +'，';
		}
		if(value.checkRstFlag == 0 || value.checkRstFlag == 2){
			if(value.checkRst != ""){
				rst+=value.checkRst+'，';
			}
		}
		if(value.checkRstFlag == 1){
			if(value.checkRst == "" || value.checkRst == "检查结果："){
				alert('"检查结果"为必填项');
				return -1;
			}
			rst+=value.checkRst+'，';
		}
	
		temp=getRowValue('diagRstFlag',value.diagRstFlag);
		if(temp=='有明确诊断'){
			if(value.diagRst == "诊断为"){
				alert('"诊断为"为必填项');
				return -1;
			}
			rst+=value.diagRst+'，';
		}else if(temp=='其它'){
			if(value.diagRst0 != ""){
				rst+=value.diagRst0+'，';
			}
		}else if(temp=='未明确诊断'){
			if(value.diagRst != ""){
				rst+=value.diagRst+'，';
			}
		}
		temp=getRowValue('treatFlag',value.treatFlag);
		if(temp.length>0){
			if(temp=='未行治疗' || temp=='具体治疗不详' || temp=='为进一步诊治收治入院'||temp=='有具体治疗' || temp=='其它'){
				if(value.treat != ""){
					rst+=value.treat + '，';
				}
			}else if(temp=='自行服药治疗'){
				if(value.treat == "自行服用"){
					alert('"自行服药治疗"为必填项');
					return -1;
				}
				rst+=value.treat+'，';
			}
		}
		rst=rst.length>0?(rst.substr(0,rst.length-1)+'。'):'';
	}
	return rst;
}
</script>
<style type="text/css">
*{
	font-size:12px;
}
textarea{
	width:95%;
	height:40px;
}
input.text{
	width:95%;
}
</style>
</head>

<body style="width:100%;">
<div id="toolbar" style="text-align:right;width:820px">
	<button class="btn" id="ok-btn">确定</button>
	<button class="btn" id="cancel-btn" onclick="backToPreIllWindow()">取消</button>
</div>
<form>
<table width="820" border=1 cellSpacing=0 borderColorDark=#ffffff cellPadding=2>
	<tr>
		<td class="t2" colspan="2">&nbsp;</td>
	</tr>
	<tr>
		<td class="t1" width="100">诊疗经过：</td>
		<td width="*"><input type="radio" name="treatProcessFlag" class="radio dict-fld"/></td>
	</tr>
</table>
<table id="memoTable" width="820" border=1 cellSpacing=0 borderColorDark=#ffffff cellPadding=2 style="display:none">
	<tr>
		<td class="t1" width="100">具体说明：</td>
		<td width="*"><textarea name="treatProcessDesc"></textarea></td>
	</tr>
</table>

<table id="unit" width="820" border=1 cellSpacing=0 borderColorDark=#ffffff cellPadding=2 style="display:none">
	<tr>
		<td class="t1" width="100">医院名称：</td>
		<td width="*">
			<input type="radio" name="hospitalName" value="1"/>当地医院
			<input type="radio" name="hospitalName" value="2"/>外地医院
		</td>
	</tr>
	<tr style="display:none;">
		<td class="t1" width="100">&nbsp;</td>
		<td width="*"><input type="text" class="text" name="inspectionUnit"/></td>
	</tr>
</table>
<table id="detailTable" width="820" border=1 cellSpacing=0 borderColorDark=#ffffff cellPadding=2 style="display:none">
	<tr>
		<td class="t1" width="100">就诊时间：</td>
		<td class="t2" width="*"><input name="treatTime" type="text" class="text" style="width:80px"/>
					   <input name="treatTimeUnit" type="text" class="select" style="width:60px"/>
					   <input name="treatTimeUnitSuffix" type="text" class="select" style="width:60px"/>
		</td>
	</tr>
	<tr>
		<td class="t1">就诊方式：</td>
		<td width="t2">
		<input type="radio" name="treatFn" class="radio dict-fld"/>
		</td>
	</tr>
	<tr style="display:none;">
		<td class="t1">&nbsp;</td>
		<td width="t2">
			<input type="text" name="treatFn0" class="text"/></br><font style="color:red">(注：系统预置了组合文字，如不需要，请自行修改，句末不加标点)</font>
		</td>
	</tr>
</table>
<table id="detailTable2" width="820" border=1 cellSpacing=0 borderColorDark=#ffffff cellPadding=2 style="display:none">
	<tr>
		<td class="t1">检查情况：</td>
		<td width="t2"><input type="radio" name="checkRstFlag" class="radio dict-fld"/></td>
	</tr>
	<tr class="hidden">
		<td class="t1">&nbsp;</td>
		<td width="t2"><textarea name="checkRst"></textarea></br><font style="color:red">(注：系统预置了组合文字，如不需要，请自行修改，句末不加标点)</font></td>
	</tr>
	<tr>
		<td class="t1">诊断情况：</td>
		<td width="t2"><input type="radio" name="diagRstFlag" class="radio dict-fld"/></td>
	</tr>
	<tr class="hidden">
		<td class="t1">&nbsp;</td>
		<td width="t2"><input type="text" name="diagRst" class="text"/></td>
	</tr>
	<tr class="hidden">
		<td class="t1">&nbsp;</td>
		<td width="t2"><input type="text" name="diagRst0" class="text"/></td>
	</tr>
	<tr>
		<td class="t1">治疗结果：</td>
		<td width="t2"><input type="radio" name="treatFlag" class="radio dict-fld"/></td>
	</tr>
	<tr name="zhiliaomiaoshu">
		<td class="t1">&nbsp;</td>
		<td width="t2"><textarea name="treat"></textarea><img id="treatImg" name="treatImg" src="../../../PUBLIC/images/sign.gif" class="hand hidden" flag="presentHistory"/></br><font style="color:red">(注：系统预置了组合文字，如不需要，请自行修改，句末不加标点)</font></td>
	</tr>
</table>
</form>
<div id="composeInfo" style="display:none"></div>
</body>
</html>
